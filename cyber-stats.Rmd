---
title: "Education statistics relevant to Scottish Cyber Resilience"
author: "Jean Carletta"
date: "May 2023"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    theme:
      bg: "#101010"
      fg: "#ffffff"
      primary: "#E69F00"
      base_font:
        google: Prompt
      code_font:
        google: JetBrains Mono
---


```{css}

.sbframe-commentary {
  width: 500px;
  color: "#E69F00";
}


td { font-size: 10px }

```

```{r setup, include=FALSE}
library(flexdashboard)
library(plotly)
library(tidyverse)# cut this down??
library(readxl)
library(tidyr) # required for separate functionality
library(htmlwidgets)
library(htmltools)
# Install thematic and un-comment for themed static plots (i.e., ggplot2)
# thematic::thematic_rmd()

# colorblind-friendly palettes from http://www.cookbook-r.com/Graphs/Colors_%28ggplot2%29/#a-colorblind-friendly-palette -
# original credit looks like  http://jfly.iam.u-tokyo.ac.jp/color/, but that no longer exists.

# The palette with grey:
#cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# The original palette with black:
cbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

my_theme <- theme(plot.title=element_text(size=14,face="bold"),axis.text=element_text(size=12),axis.text.x = element_text(angle=90), axis.title=element_text(size=12),strip.text.x = element_text(size = 14))

## Most files we have to load directly - something about the web setup means they won't using the URL

SQA_awards_filename <- "./data-sources/attainment-statistics-december-2022.xlsx"

teacher_census_filename <- "./data-sources/Teacher+Census+Supplementary+Statistics+2022.xlsx"
# possible data we could add: [Post-probationer teacher employment - dashboard](https://scotland.shinyapps.io/sg-post-probationer-employment-dashboard/)

ga_filename = "./data-sources/ga-supplementary-tables-2022-v13.xlsx"

HESQ_filepath <- "./data-sources/SFC-HESQ"

HESQ_2018_filename <- "./data-sources/SFC-HESQ/HESQ_2018-19_Background_Tables.xlsx"

# from https://www.hesa.ac.uk/collection/c22061 covering 2023/24 academic year
unistats_filepath_2023 <- "./data-sources/unistats-2022-3-c22061/on_2023_05_02_13_16_10/"
unistats_institution_filename <- paste0(unistats_filepath_2023,"INSTITUTION.csv")
unistats_course_filename <- paste0(unistats_filepath_2023,"KISCOURSE.csv")
unistats_aim_filename <- paste0(unistats_filepath_2023,"KISAIM.csv")

HECOS_CAH_Mapping_filename <- "./data-sources/HECoS_CAH_Mappings.csv"
# HECoS codes relating to cyber security  
cyber_codes <- c("100376", "100385", "100365") # cyber or networking
cyber_word_regexp <- "(cyber|security|hacking|forensics|resilience|network)"

# longitudinal data files
HESA_table_26_filename <-"./data-sources/table-26.csv"
HESA_table_54_filename <- "./data-sources/table-54.csv"

# data that comes one file per year, so we need to get a directory worth of files to do longitudinal analysis

HESA_table_5_filepath <- "./data-sources/table-5"
HESA_table_11_filepath <- "./data-sources/table-11"
HESA_table_49_filepath <-"./data-sources/table-49"

## to check we haven't missed relevant HECOS codes
#HECOS_codes <- read.csv("~/CRU-statistical-reporting-2023/courses/data-sources/unistats-list-of-HECOS-codes/valid-entries.csv")

#cyber_HECOS <- HECOS_codes %>%
#  filter(grepl("(cyber|security|forensics)",Label, perl=TRUE, ignore.case = TRUE)) ## this is very coarse. Check whole set by eye!

```
### Introduction

This storyboard shows plots based on open data about education that bear on Scotland's cyber resilience from secondary school onwards.  There are three types of education included:

- ***Material every student should learn to protect themselves.*** Of the qualifications covered, currently only Cyber Security Fundamentals at SCQF Level 4 falls into this category.

- ***Cyber security qualifications.*** These are sufficient for entry-level technical cyber security jobs.  Statistics for them are still in their infancy because the subject coding that pulls them out is still not fully deployed.

- ***Computing qualifications.*** While it is hard to derive good cyber security statistics, checking the state of computing qualifications in general is still the closest we can get.   

In addition, we include a plot of research income in computing.  A strong research community is required to compete for future PhD students. 

The data sources behind this report change once a year. This version uses the data that was available at 1 May 2023.

### Cyber Security Fundamentals at SCQF Level 4 - Attainment

```{r csf}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE, fig.width=10, fig.height=5, results='asis')

code_of_interest = "Cyber Security Fundamentals" # Make sure this is how SQA spells it in their files.

# 0 means exactly 0 students; [c] means suppressed because counts too low; [z] means doesn't apply and it isn't at all clear from the spreadsheet what this means; other numbers are rounded to the nearest 5.  There aren't any [z]'s for Cyber Security so I haven't tracked this down.
# 
# The SQA do not offer CSV. The EA workbook has one sheet per educational authority with their data for all NPAs.  
# 

# Tidyverse's readxl library can read one sheet at a time from a workbook, specified by sheet name or position (integer).  NB if a file isn't found or is open elsewhere, it will report an incorrect error that the file is a zip file.  
# 
# Create a table that has the Education Authority Name, table number,  and the sheet name, presumed to be "EA[X]".

main_longitudinal_df <- read_excel(SQA_awards_filename, 10, skip = 2) %>%
  filter(grepl(code_of_interest,Subject,fixed=TRUE)) %>%
  pivot_longer(cols = starts_with("Awarded Count "), names_prefix = "Awarded Count ", names_to= "year", values_to = "count") %>%
  mutate(count = as.numeric(count))

ggplotly(ggplot(main_longitudinal_df, aes(x=year,y=count,fill=Level)) + geom_col() + labs(y = "Number of awards", x="year") + scale_fill_manual(values=cbPalette) + my_theme + theme(legend.position = "none"))

```

***

#### Cyber Security Fundamentals at SCQF Level 4 - Attainment

Cyber Security Fundamentals at SCQF Level 4 - Attainment

**Data source:** [Scottish Qualifications Authority](https://www.sqa.org.uk/sqa/102188.html)

- [Attainment Statistics (December 2022)](https://www.sqa.org.uk/sqa/files_ccc/attainment-statistics-december-2022.xlsx)


The data gives the number of Awards, including for the Award in Cyber Security Fundamentals at SCQF Level 4. 

Attainment is counted against a year if the award was achieved before August of that year.  That is, for 2022, the award was made between 1 Aug 2021 and 31 July 2022.

### Highers and Advanced Highers in Computing Science - Entries and Attainment

```{r highers}
code_of_interest = "Computing Science" # Make sure this is how SQA spells it in their files.

higher_df <- read_excel(SQA_awards_filename, sheet="Higher", skip = 2) %>%
  filter(grepl(code_of_interest,Subject,fixed=TRUE)) %>%
  select(starts_with("Grade A-D Count"),starts_with("Entries")) %>%
  mutate(across(1:10, as.integer)) %>%
  pivot_longer(cols = starts_with("Grade A-D Count ")| starts_with("Entries"), names_to= "type", values_to = "count") %>%
  mutate(year = substring(type,str_length(type)-3,str_length(type))) %>%
  mutate(type = substring(type,1,str_length(type)-4)) %>%
  mutate(type = case_when(type =="Grade A-D Count " ~ "Awards", type =="Entries " ~ "Entries")) %>%
  #pivot_wider(names_from=type,values_from=count) %>%
  mutate(level = "Higher")

advanced_higher_df <- read_excel(SQA_awards_filename, sheet="Advanced_Higher", skip = 2) %>%
  filter(grepl(code_of_interest,Subject,fixed=TRUE)) %>%
  select(starts_with("Grade A-D Count"),starts_with("Entries")) %>%
  mutate(across(1:10, as.integer)) %>%
  pivot_longer(cols = starts_with("Grade A-D Count ")| starts_with("Entries"), names_to= "type", values_to = "count") %>%
  mutate(year = substring(type,str_length(type)-3,str_length(type))) %>%
  mutate(type = substring(type,1,str_length(type)-4)) %>%
  mutate(type = case_when(type =="Grade A-D Count " ~ "Awards", type =="Entries " ~ "Entries")) %>%
  # pivot_wider(names_from=type,values_from=count) %>%
  mutate(level = "Advanced Higher")

df <- rbind(higher_df,advanced_higher_df) 

## can't figure out how to get alphabetic order, rely on there
## being more highers than advanced highers.
df$level <- reorder(df$level,df$count, decreasing=TRUE,order=TRUE)

ggplotly(ggplot(df, aes(x=year,y=count,fill=type)) + my_theme + geom_col(position="dodge",stat="identity") + labs(y="Number") + facet_wrap(~level) + scale_fill_manual(values=cbPalette)
)

```

***

#### Highers and Advanced Highers in Computing Science - Entries and Attainment

**Data source:** [Scottish Qualifications Authority](https://www.sqa.org.uk/sqa/102188.html)

- [Attainment Statistics (December 2022)](https://www.sqa.org.uk/sqa/files_ccc/attainment-statistics-december-2022.xlsx)


The data gives the number of Highers and Advanced Highers awarded in the years 2018-2022.


Attainment is counted against a year if the award was achieved before August of that year.  That is, for 2022, the award was made between 1 Aug 2021 and 31 July 2022.

### Number of Secondary School Teachers for Computing Studies as main subject 

```{r computing_teachers}

## would be safer to read the list of tables and find the sheet with the right name - the NPA code cell takes that approach.

main_longitudinal_df <- read_excel(teacher_census_filename, sheet="Table 3.9", skip = 3, n_max=42) %>%
  filter(Subject == "Computing Studies") %>%
  select(starts_with("2")) %>%
  ## is reading the values as mixed doubles and chars, force as integers
  pivot_longer(cols = everything(), names_to = "year",values_to = "count", values_transform = as.integer) %>%
  mutate(year = substring(year,1,4))

ggplotly(ggplot(main_longitudinal_df, aes(x=year,y=count)) + my_theme + geom_col() + labs(y="Number of teachers") + scale_fill_manual(values=cbPalette) + theme(legend.position = "none"))

# could add how many teachers each LA has.
# - Table 8.9:  Secondary school teachers by main subject taught and local authority, 2022
  
```

***

#### Number of Secondary School Teachers for Computing Studies as main subject 

**Data source:** [Scottish Government](https://www.gov.scot/publications/teacher-census-supplementary-statistics/)

- [Teacher census supplementary statistics](https://www.gov.scot/binaries/content/documents/govscot/publications/statistics/2019/07/teacher-census-supplementary-data/documents/teacher-census-supplementary-statistics-2022/teacher-census-supplementary-statistics-2022/govscot%3Adocument/Teacher%2BCensus%2BSupplementary%2BStatistics%2B2022.xlsx)
 
From this data source, we use:

- Table 3.9a: Secondary school teachers by main subject taught 2008-2022

Note that this data gives the number of teachers with Computing Studies as their main subject, not all teachers of Computing Studies.

### Computing Students entering Scottish tertiary education by level, 2015/16 to 2020/21

```{r Scottish_college_and_HE_entrants}

# table 15 is entrants but otherwise just like 10a

extract_year <- function (x) {
  pattern <- "[0-9][0-9]-[0-9][0-9]"
  m <- regexpr(pattern,x)
  regmatches(x,m)
}

# sometimes there's a column just with a "return to TOC" link in it, so pass the range to extract.
# The worksheets have a variable number of blank columns at the start, but read_excel discards those - as
# long as the number of columns in the table and their meaning is always the same, we're fine.

read_HESQ_workbook <- 
  function (f, sheet, range) {
    df <- read_excel(f, sheet=sheet, trim_ws=TRUE,col_names = FALSE) %>% 
      as.data.frame() %>% 
      select(range) %>%
      mutate(year=paste0("20",extract_year(f)))
    }

myfiles <- lapply(list.files(path=HESQ_filepath, pattern="*.xlsx", full.names=TRUE), read_HESQ_workbook, sheet="Table 15",range=1:13)


table_15 <- do.call("rbind", myfiles) 

colnames(table_15) <- c("Subject","All.Levels.Total","All.Levels.MalePC","All.Levels.FemalePC","Postgraduate.Levels.Total","Postgraduate.Levels.MalePC","Postgraduate.Levels.FemalePC","First.Degree.Levels.Total","First.Degree.Levels.MalePC","First.Degree.Levels.FemalePC","Subdegree.Levels.Total","Subdegree.Levels.MalePC","Subdegree.Levels.FemalePC","year")

table_15 <- table_15 %>%
  filter(grepl("Comput",Subject)) 

table_15_totals <- table_15 %>%
  select(Subject,year,ends_with("Total")) %>%
  pivot_longer(cols=ends_with("Total"),names_to="Level",values_to="Number") %>%
  mutate(Level = sub(".Levels.Total","",Level)) %>%
  mutate(Level = sub("\\.", " ", Level)) %>%
  filter(Level != "All") %>%
  mutate(Number = as.integer(Number))

table_15_totals$Level <- factor(table_15_totals$Level, levels=c("Postgraduate","First Degree","Subdegree"))

my_theme <- theme(plot.title=element_text(size=14,face="bold"),axis.text=element_text(size=12),axis.text.x = element_text(angle=90), axis.title=element_text(size=12),strip.text.x = element_text(size = 14))

ggplotly(ggplot(table_15_totals , aes(x=year,y=Number,fill=Level)) + geom_col() + labs(x = "academic year", y="Number of entrants") + my_theme + scale_fill_manual(values=cbPalette))

```

***

#### Computing Students entering Scottish tertiary education by level, 2015/16 to 2020/21

**Data source:** Scottish Funding Council

- [HE Students and Qualifiers at Scottish Institutions 2020-21 - Table 15] (https://www.sfc.ac.uk/publications-statistics/statistical-publications/2022/SFCST052022.aspx)

The data gives the number of students in their first year of studying a computing discipline at Scottish universities and further education colleges.  From 2019-20, the subject code used is "Computing"; before this time, it is "Computer Science".

### Total Computing students in Scottish tertiary education by level, 2015/16 to 2020/21

```{r Scottish_college_and_HE_students}

extract_year <- function (x) {
  pattern <- "[0-9][0-9]-[0-9][0-9]"
  m <- regexpr(pattern,x)
  regmatches(x,m)
}

# sometimes there's a column just with a "return to TOC" link in it, so pass the range to extract.
# The worksheets have a variable number of blank columns at the start, but read_excel discards those - as
# long as the number of columns in the table and their meaning is always the same, we're fine.

read_HESQ_workbook <- 
  function (f, sheet, range) {
    df <- read_excel(f, sheet=sheet, trim_ws=TRUE,col_names = FALSE) %>% 
      as.data.frame() %>% 
      select(range) %>%
      mutate(year=paste0("20",extract_year(f)))
    }

myfiles <- lapply(list.files(path=HESQ_filepath, pattern="*.xlsx", full.names=TRUE), read_HESQ_workbook, sheet="Table 10a",range=1:13)


table_10a <- do.call("rbind", myfiles) 

colnames(table_10a) <- c("Subject","All.Levels.Total","All.Levels.MalePC","All.Levels.FemalePC","Postgraduate.Levels.Total","Postgraduate.Levels.MalePC","Postgraduate.Levels.FemalePC","First.Degree.Levels.Total","First.Degree.Levels.MalePC","First.Degree.Levels.FemalePC","Subdegree.Levels.Total","Subdegree.Levels.MalePC","Subdegree.Levels.FemalePC","year")

table_10a <- table_10a %>%
  filter(grepl("Comput",Subject)) 

table_10a_totals <- table_10a %>%
  select(Subject,year,ends_with("Total")) %>%
  pivot_longer(cols=ends_with("Total"),names_to="Level",values_to="Number") %>%
  mutate(Level = sub(".Levels.Total","",Level)) %>%
  mutate(Level = sub("\\.", " ", Level)) %>%
  filter(Level != "All") %>%
  mutate(Number = as.integer(Number))

table_10a_totals$Level <- factor(table_10a_totals$Level, levels=c("Postgraduate","First Degree","Subdegree"))

# table 10 is number of total students - other tables give entrants and qualifiers

ggplotly(ggplot(table_10a_totals , aes(x=year,y=Number,fill=Level)) + geom_col() + labs(x = "academic year", y="Number of students") + my_theme + scale_fill_manual(values=cbPalette))

```

***

#### Total Computing students in Scottish tertiary education by level, 2015/16 to 2020/21

**Data source:** Scottish Funding Council

- [HE Students and Qualifiers at Scottish Institutions 2020-21 - Table 10a] (https://www.sfc.ac.uk/publications-statistics/statistical-publications/2022/SFCST052022.aspx)

The data gives the total number of students studying a computing discipline at Scottish universities and further education colleges over all years - unlike other statistics based on entrants or qualifiers.  From 2019-20, the subject code used is "Computing"; before this time, it is "Computer Science".


### Percentage of female Computing students in Scottish tertiary education by level, 2015/16 to 2020/21

```{r Scottish_college_and_HE_students_female}


table_10a_female <- table_10a %>%
  select(Subject,year,ends_with("FemalePC")) %>%
  pivot_longer(cols=ends_with("FemalePC"),names_to="Level",values_to="Number") %>%
  mutate(Level = sub(".Levels.FemalePC","",Level)) %>%
  mutate(Level = sub("\\.", " ", Level)) %>%
  filter(Level != "All") %>%
  mutate(Number = round(as.numeric(Number)*100))


table_10a_female$Level <- factor(table_10a_totals$Level, levels=c("Subdegree", "First Degree", "Postgraduate"))

# table 10 is number of total students - other tables give entrants and qualifiers
## x axis label doesn't end up well spaced on facet wrapped plots - just omit it.

ggplotly(ggplot(table_10a_female , aes(x=year,y=Number)) + geom_col(position="dodge") + labs(y="Percentage of female students") + my_theme + scale_fill_manual(values=cbPalette) + facet_wrap(~Level,ncol=3))

```

***


#### Percentage of female Computing students in Scottish tertiary education by level, 2015/16 to 2020/21

**Data source:** Scottish Funding Council

- [HE Students and Qualifiers at Scottish Institutions 2020-21 - Table 10a] (https://www.sfc.ac.uk/publications-statistics/statistical-publications/2022/SFCST052022.aspx)

The data gives the total number of students studying a computing discipline at Scottish universities and further education colleges over all years - unlike other statistics based on entrants or qualifiers.  From 2019-20, the subject code used is "Computing"; before this time, it is "Computer Science".


### Total Computing students by type of tertiary education institution, 2015/16 to 2020/21

```{r Scottish_college_and_HE_students_provider_type}

myfiles <- lapply(list.files(path=HESQ_filepath, pattern="*.xlsx", full.names=TRUE), read_HESQ_workbook, sheet="Table 10b",range=1:10)


table_10b <- do.call("rbind", myfiles) 

colnames(table_10b) <- c("Subject","All.Total","All.MalePC","All.FemalePC","HEI.Total","HEI.MalePC","HEI.FemalePC","College.Total","College.MalePC","College.FemalePC","year")

table_10b <- table_10b %>%
  filter(grepl("Comput",Subject)) 

table_10b_totals <- table_10b %>%
  select(Subject,year,ends_with("Total")) %>%
  pivot_longer(cols=ends_with("Total"),names_to="Provider.type",values_to="Number") %>%
  mutate(Provider.type = sub(".Total","",Provider.type)) %>%
  mutate(Provider.type = sub("\\.", " ", Provider.type)) %>%
  filter(Provider.type != "All") %>%
  mutate(Number = as.integer(Number))

table_10b_totals$Provider.type <- factor(table_10b_totals$Provider.type, levels=c("HEI","College"))

# table 10x is number of total students - other tables give entrants and qualifiers

ggplotly(ggplot(table_10b_totals , aes(x=year,y=Number,fill=Provider.type)) + geom_col() + labs(x = "academic year", y="Number of students", fill="Provider type") + my_theme + scale_fill_manual(values=cbPalette))

```

***

#### Total Computing students by type of tertiary education institution, 2015/16 to 2020/21

**Data source:** Scottish Funding Council

- [HE Students and Qualifiers at Scottish Institutions 2020-21 - Table 10b] (https://www.sfc.ac.uk/publications-statistics/statistical-publications/2022/SFCST052022.aspx)

The data gives the total number of students studying a computing discipline at Scottish universities and further education colleges over all years - unlike other statistics based on entrants or qualifiers.  From 2019-20, the subject code used is "Computing"; before this time, it is "Computer Science".


### Students completing Scottish Computing tertiary qualifications, 2009/10 to 2020/21

```{r Scottish_college_and_HE_qualifiers}

# table 30 

extract_year <- function (x) {
  pattern <- "[0-9][0-9]-[0-9][0-9]"
  m <- regexpr(pattern,x)
  regmatches(x,m)
}

# sometimes there's a column just with a "return to TOC" link in it, so pass the range to extract.
# The worksheets have a variable number of blank columns at the start, but read_excel discards those - as
# long as the number of columns in the table and their meaning is always the same, we're fine.

read_HESQ_workbook <- 
  function (f, sheet, range) {
    df <- read_excel(f, sheet=sheet, trim_ws=TRUE,col_names = FALSE) %>% 
      as.data.frame() %>% 
      select(range) %>%
      mutate(year=paste0("20",extract_year(f)))
    }

file_list <- list.files(path=HESQ_filepath, pattern="*.xlsx", full.names=TRUE) 

# From 2018-19, there's just the current year's numbers and it's called Computing - process as recent_files.
# 2018-19, it was called Information Technology and there was a big table from 2009. 
# 2017-18, same but from 2008.
# before that, it's table 34 but the format is the same - so ignore this, just process 2018-19.

# Category inspection suggests they should cover the same students but I haven't found methodology notes.

recent_files <- grep("2019|2020", file_list, value=TRUE)
  
recent <- lapply(recent_files, read_HESQ_workbook, sheet="Table 30",range=1:2)

recent_table_30 <- do.call("rbind", recent) 

colnames(recent_table_30) <- c("Subject","Number","year")

recent_table_30 <- recent_table_30 %>%
  filter(grepl("Comput",Subject)) %>%
  select(-Subject)


old_table_30 <- read_excel(HESQ_2018_filename, sheet = "Table 30", skip = 2, trim_ws = TRUE) %>%
  select(-starts_with("%")) 

colnames(old_table_30)[1] <- "Subject" # :TODO: cackhanded way to deal with spaces!

old_table_30 <- old_table_30 %>%
  filter(grepl("Information",Subject)) %>%
  select(-starts_with("Subject")) %>%
  pivot_longer(names_to = "year",values_to = "Number", everything())

table_30 <- rbind(old_table_30,recent_table_30) 

ggplotly(ggplot(table_30, aes(x=year,y=Number)) + geom_col() + labs(x = "academic year", y="Number qualifying") + my_theme + scale_fill_manual(values=cbPalette))

```

***

#### Students completing Scottish Computing tertiary qualifications, 2009/10 to 2020/21

**Data source:** Scottish Funding Council

- [HE Students and Qualifiers at Scottish Institutions 2020-21 - Table 30] (https://www.sfc.ac.uk/publications-statistics/statistical-publications/2022/SFCST052022.aspx)

The data gives the number of students gaining sub-degree, first degree, or postgraduate qualifications in Computing at Scottish universities and further education colleges.  From 2019-20, the subject code used is "Computing"; before this time, it is "Information technology".


### Cyber Security undergraduate courses at Scottish universities

```{r cyber_courses}

# get the set of Scottish course providers
provider_df <- read.csv(unistats_institution_filename) %>%
    filter(COUNTRY=="XH" | UKPRN=="10007773") %>% # Open University
    select("UKPRN","LEGAL_NAME")

# get Scottish courses and then filter for which ones are cyber courses
course_df <- read.csv(unistats_course_filename) %>%
    filter(UKPRN %in% provider_df$UKPRN)   # Scottish courses.
  
# for finding out how bad the missing code problem is
no_HECOS_course_df <- course_df %>%
  filter(is.na(HECOS) & is.na(HECOS.1) & is.na(HECOS.2) & is.na(HECOS.3) & is.na(HECOS.4))

# Get a mapping from KISAIMCODES to human readable qualification labels.
kisaim_df <- read.csv(unistats_aim_filename) 

## pull out information about just the courses that are HECoS-coded as cyber or that have one of the cyber keywords in the title.
# UKPRN is a code that when matched to 
# KISMODE = 1 for Full-time, 2 for Part-time, 3 for Both
# LTURL is the URL for more information
# TITLE is the course name
# KISAIMCODE is a number that when matched to kisaim_df gives the qualification (BEng or whatever)
# SANDWICH is 0 for no sandwich year, 1 for optional, 2 for compulsory
# YEARABROAD is 0 for no year abroad, 1 for optional, 2 for compulsory

cyber_course_df <- course_df %>%
  mutate(CYBER_CODE=HECOS %in% cyber_codes | HECOS.1 %in% cyber_codes | HECOS.2 %in% cyber_codes | HECOS.3 %in% cyber_codes | HECOS.4 %in% cyber_codes ) %>%
  filter(grepl(cyber_word_regexp,TITLE, perl=TRUE, ignore.case = TRUE) | CYBER_CODE)   %>%
  select(UKPRN,TITLE,LTURL,KISAIMCODE, KISMODE,SANDWICH, YEARABROAD, FOUNDATION,HONOURS, CYBER_CODE, starts_with("HECOS")) 
  
course_codes <- cyber_course_df %>%
  select(starts_with("HECOS"))
  
  
reduce <- function(x) unname(x[!is.na(x)]) # yields list
  
cyber_course_df$CODES <- apply(course_codes, 1, reduce)
  
cyber_course_df <- cyber_course_df %>%
  merge(kisaim_df) %>%
  merge(provider_df) %>%
  select(-UKPRN,-KISAIMCODE) %>%
  mutate(FOUNDATION=case_when(FOUNDATION == 0 ~ "not available", FOUNDATION ==1 ~ "optional", FOUNDATION == 2 ~ "compulsory")) %>%
  mutate(KISAIMLABEL = case_when(HONOURS == 1 ~ paste(KISAIMLABEL, "(Hons)"), HONOURS == 0  ~ KISAIMLABEL)) %>%
  mutate(SANDWICH=case_when(SANDWICH == 0 ~ "not available", SANDWICH ==1 ~ "optional", SANDWICH == 2 ~ "compulsory")) %>%
  mutate(YEARABROAD=case_when(YEARABROAD == 0 ~ "not available", YEARABROAD ==1 ~ "optional", YEARABROAD ==2 ~ "compulsory")) %>%
  mutate(KISMODE=case_when(KISMODE == 1 ~ "full-time", KISMODE == 2 ~ "part-time", KISMODE == 2 ~ "full-time or part-time")) %>%
  # put in better order
  select(LEGAL_NAME,TITLE,KISAIMLABEL, KISMODE, FOUNDATION, SANDWICH, YEARABROAD, CYBER_CODE, CODES, LTURL) %>%
  mutate(CYBER_CODE = case_when(CYBER_CODE ~ "yes", .default = "no")) %>%
  arrange(LEGAL_NAME,TITLE,KISMODE)

headline <- paste(sprintf( "%1.f%%",100*(dim(no_HECOS_course_df)[1]/dim(course_df)[1])), "of all UK courses declared for academic year 2023/24 lack HECOS codes. Where a course has a HECoS code but not one from our list of cyber security, it could be miscoded.\n")

knit_print.html(paste0("<p>",headline,"</p>"))

knitr::kable(cyber_course_df, col.names=c("HEI","Course","Aim","Mode","Foundation","Sandwich","Year Abroad","Coded as Cyber?","Code","URL"))

```



***

#### Cyber Security undergraduate courses at Scottish universities

**Data source:**  [Higher Education Statistics Authority, Unistats record 2022/23](https://www.hesa.ac.uk/collection/c22061)

This source lists undergraduate university courses that universities have declared will be run in 2023/24.  Because this information is prospective, it is subject to change.  The source uses the new HECoS subject codes but most courses still do not complete this part of the return.

We consider the following codes to represent the bulk of cyber security education:

HECoS Code |HECoS Label  | 
|--- | ---| 
|100365|computer networks|
|100376|computer and information security |
|100385|computer forensics|

 Although it would be possible to teach computer networks without substantive cyber security content, this is unlikely.  In practice, many employers are happy to hire students with good networking backgrounds for specialist cyber security job roles.
 
 We identify cyber courses by looking for any with these codes or with titles that match any of the following patterns as words or parts of words:

- cyber,security,hacking,forensics,resilience,network

Titles are provided in the data as supplied by the university without further validation; any spelling mistakes will mean the course is not picked up in the search.  The search can potentially return irrelevant results - for instance, food security courses and forensics courses that are completely about chemistry. 

### Students at Scottish universities studying computing disciplines, 2019/20 to 2021/22  

```{r Scottish_uni_computing_students}

quals_of_interest = c("All undergraduate","Postgraduate (taught)", "Postgraduate (research)")

extract_year <- function (x) {
  pattern <- "[0-9][0-9]-[0-9][0-9]"
  m <- regexpr(pattern,x)
  regmatches(x,m)
}

read_table_49_csv <- 
  function (f) {
                df <- read.csv(f,skip=13) %>%
                  filter(Region.of.HE.provider == "Scotland") %>%
                  filter(Country.of.HE.provider == "Scotland") %>%
                  filter(grepl("^11", CAH.level.subject)) %>%
                  filter(Mode.of.study == "All") %>%
                  filter(HE.provider !="Total") %>%
                  filter(CAH.level.subject != "11 Computing") %>%
                  filter(Level.of.study %in% quals_of_interest) %>%
                  filter(Number > 0) %>%
                  select(-Mode.of.study,-Region.of.HE.provider, -CAH.level.marker, -Country.of.HE.provider, -UKPRN) 
                df
  }

myfiles <- lapply(list.files(path=HESA_table_49_filepath, pattern="*.csv", full.names=TRUE), read_table_49_csv) 

table_49 <- do.call("rbind", myfiles) 

table_49_summary <- table_49 %>%
  group_by(Academic.Year,Level.of.study)%>%
  summarise(across(c(Number), sum))

table_49_summary$Level.of.study <- factor(table_49_summary$Level.of.study, levels=c("Postgraduate (research)", "Postgraduate (taught)", "All undergraduate"))

ggplotly(ggplot(table_49_summary, aes(y=Number,x=Academic.Year))  + geom_bar(aes(fill=Level.of.study), stat="identity") + labs(x = "Academic year",y="Number of students enrolled",fill="Level of study")  + my_theme + scale_fill_manual(values=cbPalette))


```

***

#### Students at Scottish universities studying computing disciplines, 2019/20 to 2021/22  

**Data source:** [Higher Education Statistics Authority](https://www.hesa.ac.uk/data-and-analysis)

-  [HESA Table 49 - HE student enrolments by HE provider, CAH level 1 subject, CAH level 3 subject, level of study, mode of study and academic year 2019/20 to 2021/22](https://www.hesa.ac.uk/data-and-analysis/students/table-49.csv) 

### Students at Scottish universities studying computing disciplines - by subject, 2021/22
```{r}

by_subject <- table_49 %>%
  filter(Academic.Year=="2021/22") %>%
  group_by(CAH.level.subject,Level.of.study)%>%
  summarise(across(c(Number), sum))

# can set height = 500 in ggplotly, but what's the best number of pixels?


by_subject$Level.of.study <- factor(by_subject$Level.of.study, levels=c("Postgraduate (research)","Postgraduate (taught)","All undergraduate"))

ggplotly(ggplot(by_subject, aes(y=reorder(CAH.level.subject,desc(CAH.level.subject)),x=Number))  + geom_bar(aes(fill=Level.of.study),stat="identity") + labs(x = "Students enrolling in 2021/22",y="subject",fill="Level of study")  + my_theme + scale_fill_manual(values=cbPalette))


```

***

#### Students at Scottish universities studying computing disciplines - by subject, 2021/22

**Data source:** [Higher Education Statistics Authority](https://www.hesa.ac.uk/data-and-analysis)

-  [HESA Table 49 - HE student enrolments by HE provider, CAH level 1 subject, CAH level 3 subject, level of study, mode of study and academic year 2019/20 to 2021/22](https://www.hesa.ac.uk/data-and-analysis/students/table-49.csv) 
- [Notes for HESA Table 49](https://www.hesa.ac.uk/data-and-analysis/students/table-49)
- [Mapping between JACS and HECoS subject codes via the Common Aggregation Hierarchy (CAH)](https://www.hesa.ac.uk/files/HECoS_CAH_Mappings.csv?20235101019) 
- [Notes for Mapping](https://www.hesa.ac.uk/support/documentation/HECoS/cah)

Note that this data source does not use the new HECoS codes that allow cyber security students to be identified.  Cyber security students codes fall into the following subjects:

|HECoS Code |HECoS Label  | CAH3 Code | CAH3 label |
|--- | --- | ---| ---|
|100365|computer networks|11-01-01|computer science|
|100376|computer and information security |11-01-04|software engineering|
|100385|computer forensics|11-01-08|others in computing|



### Students at Scottish universities studying computing disciplines - by institution, 2021/22

```{r Scottish_uni_computing_by_inst}

by_institution <- table_49 %>%
  filter(Academic.Year=="2021/22") %>%
  group_by(HE.provider,Level.of.study)%>%
  summarise(across(c(Number), sum))

by_institution$Level.of.study <- factor(by_institution$Level.of.study, levels=c("Postgraduate (research)","Postgraduate (taught)","All undergraduate"))

ggplotly(ggplot(by_institution, aes(y=reorder(HE.provider,desc(HE.provider)),x=Number)) + geom_bar(aes(fill=Level.of.study),stat="identity") + labs(x = "Students enrolling in 2021/22", fill="Study level", y = NULL) + my_theme + scale_fill_manual(values=cbPalette))
```

***

#### Students at Scottish universities studying computing disciplines - by institution, 2021/22

**Data source:** [Higher Education Statistics Authority](https://www.hesa.ac.uk/data-and-analysis) 

-  [HESA Table 49 - HE student enrolments by HE provider, CAH level 1 subject, CAH level 3 subject, level of study, mode of study and academic year 2019/20 to 2021/22](https://www.hesa.ac.uk/data-and-analysis/students/table-49.csv) 
- [Notes for HESA Table 49](https://www.hesa.ac.uk/data-and-analysis/students/table-49)

### Scots studying Cyber Security at UK universities, 2019/20 to 2021/22

```{r Scots_studying_cyber}
code_map <- read.csv(HECOS_CAH_Mapping_filename, skip = 0) 

cyber_map <- code_map %>%
  filter(grepl("(100376|100385|100365)",HECoS_Code)) %>%
  select(-starts_with("CAH2"),-starts_with("CAH1"))

quals_of_interest = c("All undergraduate","Postgraduate (taught)", "Postgraduate (research)")

domiciles_of_interest = c("Scotland")

modes_of_interest = c("All")

table_54 <- read.csv(HESA_table_54_filename, skip = 15) %>%
  filter(Level.of.qualification %in% quals_of_interest) %>%
  filter(Domicile.marker %in% domiciles_of_interest) %>%
  filter(Mode.of.study %in% modes_of_interest) 


table_54_HECoS_cyber <- table_54 %>% 
  filter(CAH.level.marker == "HECoS") %>%
  filter(substring(CAH.level.subject,1,6) %in% cyber_map$HECoS_Code)


ggplotly(ggplot(table_54_HECoS_cyber, aes(x=Academic.Year,y=Number)) +  geom_col(aes(fill=CAH.level.subject)) + labs(x = "Academic year",y= "Number of students qualifying", fill="subject") + my_theme + scale_fill_manual(values=cbPalette))


```

***

#### Scots studying Cyber Security at UK universities, 2019/20 to 2021/22

**Data source:** [Higher Education Statistics Authority](https://www.hesa.ac.uk/data-and-analysis)

- [Table 54 - HE qualifiers by subject of study and domicile 2019/20 to 2021/22](https://www.hesa.ac.uk/data-and-analysis/students/table-54) 

Table 54 shows students completing qualifications at UK higher education institutions by domicile, or country of home address. The table provides the number of full-person equivalent students at UK higher education institutions by subject of study.  If a student's course is split across subjects, only a proportion of that student will count towards the numbers.

HECoS contains the following codes that we consider to be core cyber security subjects. Although it would be possible to teach computer networks without substantive cyber security content, this is unlikely. In practice, many employers are happy to hire students with good networking backgrounds for specialist cyber security job roles.

|HECoS Code |HECoS Label  |
|--- | ---|
|100365|computer networks|
|100376|computer and information security |
|100385|computer forensics|11-01-08|

***We assume these numbers are artificially low, as not all courses currently have HECoS codes.***

### Scots studying Computing at UK universities by level, 2019/20 to 2021/22

```{r Scots_studying_computing}
computing_map <- code_map %>%
  filter(grepl("^11",CAH3_Code)) %>%
  select(CAH3_Code,CAH3_Label,HECoS_Code, HECoS_Label) %>%
  arrange(CAH3_Code,HECoS_Code) %>%
  mutate(cyber = (case_when(HECoS_Code %in% cyber_map$HECoS_Code ~ "yes")))

table_54_HECoS_computing <- table_54 %>% 
  filter(CAH.level.marker == "HECoS") %>%
  filter(substring(CAH.level.subject,1,6) %in% computing_map$HECoS_Code)

by_study_level <- table_54_HECoS_computing %>%
  group_by(Academic.Year,Level.of.qualification)%>%
  summarise(across(c(Number), sum))

by_study_level$Level.of.qualification <- factor(by_study_level$Level.of.qualification, levels=c("Postgraduate (research)","Postgraduate (taught)","All undergraduate"))

ggplotly(ggplot(by_study_level, aes(x=Academic.Year,y=Number)) + geom_col(aes(fill=Level.of.qualification)) + labs(x = "Academic year",y= "Number of students", fill="study level") + my_theme + scale_fill_manual(values=cbPalette))
```

***

#### Scots studying Computing at UK universities by subject, 2019/20 to 2021/22

**Data source:** [Higher Education Statistics Authority](https://www.hesa.ac.uk/data-and-analysis)

- [Table 54 - HE qualifiers by subject of study and domicile 2019/20 to 2021/22](https://www.hesa.ac.uk/data-and-analysis/students/table-54) 
- [Mapping between JACS and HECoS subject codes via the Common Aggregation Hierarchy (CAH)](https://www.hesa.ac.uk/files/HECoS_CAH_Mappings.csv?20235101019) 
- [Notes for Mapping](https://www.hesa.ac.uk/support/documentation/HECoS/cah)

Table 54 shows students completing qualifications at UK higher education institutions by domicile, or country of home address. The table provides the number of full-person equivalent students at UK higher education institutions by subject of study.  If a student's course is split across subjects, only a proportion of that student will count towards the numbers.

The HECoS coding system does not specifically identify the set of computing disciplines. We use the mapping between HECoS codes and the CAH system to construct the set. In the CAH system, computing disciplines are all CAH area 11.

### Scots studying Computing at UK universities by subject, 2021/22

```{r Scots_studying_computing_by_subject}
table_54_HECoS_computing_by_subject <- table_54_HECoS_computing %>%
  filter(Academic.Year == "2021/22") %>%
  filter(Number > 0) %>%
  # star the cyber categories%>%
  mutate(CAH.level.subject= case_when(substr(CAH.level.subject,1,6) %in% cyber_map$HECoS_Code ~ paste("***",CAH.level.subject), .default = CAH.level.subject)) %>%
  group_by(cyber = case_when(substr(CAH.level.subject,1,6) %in% cyber_map$HECoS_Code ~ "cyber", .default="other computing")) %>%
  arrange(CAH.level.subject)

table_54_HECoS_computing_by_subject$Level.of.qualification <- factor(table_54_HECoS_computing_by_subject$Level.of.qualification, levels=c("Postgraduate (research)","Postgraduate (taught)","All undergraduate"))

ggplotly(ggplot(table_54_HECoS_computing_by_subject, aes(y = reorder(CAH.level.subject, desc(CAH.level.subject)),x=Number)) + geom_bar(stat="identity",aes(fill=Level.of.qualification)) + labs( x = "Number of students qualifying",y= NULL, fill="Level of qualification") + my_theme + scale_fill_manual(values=rep(cbPalette,6)))

```

***

#### Scots studying Computing at UK universities by subject, 2021/22

**Data source:** [Higher Education Statistics Authority](https://www.hesa.ac.uk/data-and-analysis)

- [Table 54 - HE qualifiers by subject of study and domicile 2019/20 to 2021/22](https://www.hesa.ac.uk/data-and-analysis/students/table-54) 
- [Mapping between JACS and HECoS subject codes via the Common Aggregation Hierarchy (CAH)](https://www.hesa.ac.uk/files/HECoS_CAH_Mappings.csv?20235101019) 
- [Notes for Mapping](https://www.hesa.ac.uk/support/documentation/HECoS/cah)

Table 54 shows students completing qualifications at UK higher education institutions by domicile, or country of home address. The table provides the number of full-person equivalent students at UK higher education institutions by subject of study.  If a student's course is split across subjects, only a proportion of that student will count towards the numbers.

The HECoS coding system does not specifically identify the set of computing disciplines. We use the mapping between HECoS codes and the CAH system to construct the set. In the CAH system, computing disciplines are all CAH area 11.  Cyber security subjects are starred and listed first. 

Cyber security research postgraduates are probably currently coded as "100366 Computer science".  The reason for this is not clear.

### Graduate Apprenticeships in Cyber Security at SCQF levels 10 and 11 - Enrolments, 2022 

```{r ga}

codes_of_interest = list("Cyber Security L10","Cyber Security L11") # Make sure this is how SDS spells it in their files.

# SDS hasn't structured the data the best way - instead of using a separate column for years, they have years as 
# subheaders in the provider (first column) and that column has no header.  
## read into one big table skipping the header.  Rows 1, 19, 37, ... have the years, findable by modulo arithmetic.
## Add a column name for provider.
## for each row, add a new academic_year column which takes the value of the "provider" for the
##  appropriate "sub header", and remove the "sub header" rows.
df <- read_excel(ga_filename, sheet = "1.3", skip = 7, col_names = TRUE, trim_ws=TRUE, .name_repair = "universal") 

# * means less than 5 or allows calculation of a number less than 5.  There are also blanks for Glasgow and Heriot Watt in
# 2019/20 but it's impossible to tell whether they are meant to be 0 (-) or *.

colnames(df)[1] <- "provider" # this is very fragile code to name a column, but hard to do better without a header!

df <- df %>%
  select(provider,starts_with("Cyber")) %>%
  rowid_to_column() 
  

year_for_rownum <- function (rownum){
  df$provider[((floor((rownum-1)/18)*18) + 1)]
}

df <- df %>%
  mutate(academic_year = year_for_rownum(rowid)) %>%
  filter(!grepl("[0-9][0-9][0-9][0-9]/[0-9][0-9]",provider)) %>%
  select(-rowid) 

# extract the grand total lines - the numbers are all big enough to plot.
grand_total_df <- df %>%
  filter(grepl("Grand Total",provider, fixed = TRUE)) %>%
  pivot_longer(cols = starts_with("Cyber"), names_to = "level", values_to = "count") %>%
  mutate(count = as.integer(count)) %>%
  mutate(level = gsub("."," ",level,fixed=TRUE))

ggplotly(ggplot(grand_total_df, aes(x=academic_year,y=count,fill=level)) + geom_col() + labs(x = "academic year", y="enrolments") + facet_wrap(~level) + scale_fill_manual(values=cbPalette) + my_theme + theme(legend.position = "none"))

```

***

#### Graduate Apprenticeships in Cyber Security at SCQF levels 10 and 11 - Enrolments, 2022 

**Data source:** [Skills Development Scotland](https://www.skillsdevelopmentscotland.co.uk/publications-statistics/statistics/)

- [Graduate Apprenticeship supplementary tables, 2022] (https://www.skillsdevelopmentscotland.co.uk/media/49946/ga-supplementary-tables-2022-v13.xlsx)

The data describes "uptake" of the Graduate Apprenticeships in Cyber Security at Scottish Credit and Qualifications Framework levels 10 and 11.  Although the data set does not specify, the accompanying reporting suggests that the numbers reported are for enrolments, i.e., those starting the programmes.  


### Full-Time Equivalent Higher Education Staff in Computing Disciplines, 2014/15 to 2021/22

```{r he_staff_longitudinal}

read_table_11_csv <- 
  function (f) {
                year_char_index <- regexpr("\\(20",f) +3
                year <- as.integer(substr(f,year_char_index,year_char_index+1))
                skip_row_number <- case_when(year > 18 ~ 14, .default = 15)
                df <- read.csv(f,skip=skip_row_number) %>% 
                        #filter(Country.of.HE.provider=="Scotland") %>% 
                        #filter(Region.of.HE.provider=="All") %>% 
                        filter(Category.Marker=="Cost centre") %>% 
                        filter(grepl("Total", Category) | grepl("121", Category))
  }

myfiles = lapply(list.files(path=HESA_table_11_filepath, pattern="*.csv", full.names=TRUE), read_table_11_csv) 

df <- do.call("rbind", myfiles)

UK_computing_academics_df <- df %>%
  filter(grepl("121", Category)) %>%
  filter(Country.of.HE.provider=="All") %>%
  filter(Region.of.HE.provider=="All") %>%
  filter(Contract.marker != "Academic (including atypical)") %>%
  filter(Contract.marker != "Non-academic") %>%
  filter(!grepl("All",Contract.marker)) %>%
  filter(HE.Provider == "Total")

Scottish_academics_df <- df %>%
  filter(Category == "Total academic cost centres") %>% 
  filter(Country.of.HE.provider=="Scotland") %>%
  filter(Region.of.HE.provider=="All") %>%
  filter(Contract.marker != "Academic (including atypical)") %>%
  filter(Contract.marker != "Non-academic") %>%
  filter(!grepl("All",Contract.marker)) %>%
  filter(HE.Provider == "Total")

Scottish_computing_academics_df <- df %>%
  filter(grepl("121", Category)) %>%
  filter(Country.of.HE.provider=="Scotland") %>% 
  filter(Region.of.HE.provider=="All")  %>%
  filter(Contract.marker != "Academic (including atypical)") %>%
  filter(Contract.marker != "Non-academic") %>%
  filter(!grepl("All",Contract.marker)) 

total_Scottish_computing_academics_df <- Scottish_computing_academics_df %>%
  filter(HE.Provider == "Total") 

new = total_Scottish_computing_academics_df %>% filter(grepl("2021/22",Academic.Year)) %>% select(Number) %>% sum() 
old = total_Scottish_computing_academics_df %>% filter(grepl("2014/15",Academic.Year)) %>% select(Number) %>% sum() 

Scottish_cs_pc_growth = ((new-old)/old) * 100

new = Scottish_academics_df %>% filter(grepl("2021/22",Academic.Year)) %>% select(Number) %>% sum() 
old = Scottish_academics_df %>% filter(grepl("2014/15",Academic.Year)) %>% select(Number) %>% sum() 

total_pc_growth = ((new-old)/old) * 100

new = UK_computing_academics_df %>% filter(grepl("2021/22",Academic.Year)) %>% select(Number) %>% sum() 
old = UK_computing_academics_df %>% filter(grepl("2014/15",Academic.Year)) %>% select(Number) %>% sum() 

total_UK_cs_pc_growth = ((new-old)/old) * 100

ggplotly(ggplot(total_Scottish_computing_academics_df, aes(x=Academic.Year,y=Number)) + geom_col(aes(fill=Contract.marker)) + labs(x = "Academic year",y= "Number of full-time equivalent staff", fill="Contract type") + my_theme + scale_fill_manual(values=cbPalette))

```

*** 

#### Full-Time Equivalent Higher Education Staff in Computing Disciplines, 2014/15 to 2021/22

```{r}

headline <- paste0("The number of full-time equivalent Scottish computing academics grew by ",sprintf("%2.0f%%",Scottish_cs_pc_growth), " from 2014/15 to 2021/22.\nThis is compared to ", sprintf("%2.0f%%",total_pc_growth), " for Scottish academics of all disciplines and ", sprintf("%2.0f%%",total_UK_cs_pc_growth), " for UK computing academics.")

knit_print.html(paste0("<p>",headline,"</p>"))
```

**Data source:** Higher Education Statistics Authority

- [Table 11 - HE staff FTE by HE provider and cost centre 2014/15 to 2021/22](https://www.hesa.ac.uk/data-and-analysis/staff/table-11)

In the data, academic staff are categorised by cost centres that represent a cluster of academic disciplines.  This analysis uses the cost centre "121 IT, systems sciences & computer software engineering".    It is not possible to get finer disciplines for staff from the open data.

The HESA records cover those with contracts of employment or where the higher education provider is required to pay Class 1 National Insurance contributions. Atypical staff have working arrangements that are not permanent or where there is a complex employment relationship.   It is possible for institutions to do teaching using personnel who are not included, for instance, if they are out-sourced or self-employed.  

### Full-time Equivalent Higher Education staff in Computing Disciplines by institution, 2014/15 to 2021/22


```{r HE_staff_by_institution}

# visually check this every time? Need to be careful, what happens if just one year is zero?  It should still plot...
# UHI_compute_staff <- df %>%
#   filter(grepl("Highlands",HE.Provider)) %>%
#   filter(grepl("121",Category))

provider_Scottish_computing_academics_df <- Scottish_computing_academics_df %>%
  filter(HE.Provider != "Total") %>%
  filter(Number > 0) %>%
  # names are rather long
  mutate(HE.Provider = str_remove(HE.Provider,"University of ")) %>%
  mutate(HE.Provider = str_remove(HE.Provider," University")) %>%
  mutate(HE.Provider = str_remove(HE.Provider,"The ")) %>% 
  mutate(HE.Provider = str_remove(HE.Provider,"the ")) 
  
  

ggplotly(ggplot(provider_Scottish_computing_academics_df, aes(x=Academic.Year,y=Number,fill="Contract.marker")) + geom_col(aes(fill=Contract.marker)) + labs(x = "Academic year", y = "Number of full-time equivalent staff",fill="Contract type") + my_theme + theme(strip.text.x = element_text(size="8")) + scale_fill_manual(values=cbPalette)  + facet_wrap(~HE.Provider,ncol=4))
  
```

***

#### Full-time Equivalent Higher Education staff in Computing Disciplines by institution, 2014/15 to 2021/22

**Data source:** Higher Education Statistics Authority

- [Table 11 - HE staff FTE by HE provider and cost centre 2014/15 to 2021/22](https://www.hesa.ac.uk/data-and-analysis/staff/table-11)

In the data, academic staff are categorised by cost centres that represent a cluster of academic disciplines.  This analysis uses the cost centre "121 IT, systems sciences & computer software engineering".    It is not possible to get finer disciplines for staff from the open data.

The HESA records cover those with contracts of employment or where the higher education provider is required to pay Class 1 National Insurance contributions. Atypical staff have working arrangements that are not permanent or where there is a complex employment relationship.   It is possible for institutions to do teaching using personnel who are not included, for instance, if they are out-sourced or self-employed. We omit institutions that report zero staff with employment contracts.

### Higher Education Staff in Computing Disciplines by Full-time/Part-time, 2014/15 to 2021/22

```{r he_staff_mode}

table_26 <- read.csv(HESA_table_26_filename, skip = 20) %>%  
  filter(Source.of.basic.salary == "All") %>%
  filter(Mode.of.employment != "All") %>%
  filter(Nationality != 'Total')

table_26_Scottish_cs <- table_26 %>%
  filter(Country.of.HE.provider == "Scotland") %>%
  filter(grepl("121", Category)) 
# these numbers look so high because the totals in other tables are full-time equivalent.

Scottish_cs_total <- table_26_Scottish_cs %>% filter(grepl("2021/22",Academic.Year)) %>% 
  select(Number)  %>% 
  sum()

Scottish_cs_part_time <- table_26_Scottish_cs %>% 
  filter(grepl("2021/22",Academic.Year)) %>% 
  filter(Mode.of.employment == "Part-time") %>%
  select(Number)  %>% 
  sum()
 
UK_cs_total <- table_26 %>%
  filter(grepl("121", Category)) %>%
  filter(grepl("2021/22",Academic.Year)) %>%
  select(Number)  %>%
  sum()

UK_cs_part_time <- table_26 %>%  
  filter(grepl("121", Category))  %>% 
  filter(grepl("2021/22",Academic.Year)) %>% 
  filter(Mode.of.employment == "Part-time") %>%
  select(Number)  %>% 
  sum()

Scottish_total <- table_26 %>%
  filter(Country.of.HE.provider == "Scotland") %>%
  filter(grepl("2021/22",Academic.Year)) %>%
  select(Number)  %>%
  sum()

Scottish_part_time <- table_26 %>%
  filter(Country.of.HE.provider == "Scotland") %>%
  filter(grepl("2021/22",Academic.Year)) %>%
  filter(Mode.of.employment == "Part-time") %>%
  select(Number)  %>%
  sum()


ggplotly(ggplot(table_26_Scottish_cs, aes(x=Academic.Year,y=Number)) + geom_col(aes(fill=Mode.of.employment)) + labs(x = "Academic year",fill="Mode of employment") + my_theme + scale_fill_manual(values=cbPalette))

```

*** 

#### Higher Education Staff in Computing Disciplines by Full-time/Part-time, 2014/15 to 2021/22

```{r}

headline <- paste0(sprintf("%2.0f%%",(Scottish_cs_part_time/Scottish_cs_total)*100), " of Scottish computer science academics work part-time.\n  This compares to ", sprintf("%2.0f%%",(Scottish_part_time/Scottish_total)*100), " for Scottish academics of all disciplines and ", sprintf("%2.0f%%",(UK_cs_part_time/UK_cs_total)*100), " for UK computing academics.\n")

knit_print.html(paste0("<p>",headline,"</p>"))

```

**Data source:** Higher Education Statistics Authority

- [Table 26 - HE academic staff by cost centre and nationality 2014/15 to 2021/22](https://www.hesa.ac.uk/data-and-analysis/staff/table-26)

In the data, academic staff are categorised by cost centres that represent a cluster of academic disciplines.  This analysis uses the cost centre "121 IT, systems sciences & computer software engineering".    It is not possible to get finer disciplines for staff from the open data.

The HESA records cover those with contracts of employment or where the higher education provider is required to pay Class 1 National Insurance contributions. Atypical staff have working arrangements that are not permanent or where there is a complex employment relationship.   It is possible for institutions to do teaching using personnel who are not included, for instance, if they are out-sourced or self-employed.  

### Higher Education Staff in Computing Disciplines by Nationality, 2014/15 to 2021/22

```{r he_staff_nationality}

Scottish_cs_from_UK <- table_26_Scottish_cs %>%
  filter(grepl("2021/22",Academic.Year)) %>%
  filter(Nationality == "UK") %>%
  select(Number) %>%
  sum()

#UK_cs_total <- table_26 %>%  filter(grepl("121", Category)) %>% filter(grepl("2021/22",Academic.Year)) %>% select(Number)  %>% sum()
UK_cs_from_UK <- table_26 %>%  filter(grepl("121", Category))  %>% filter(grepl("2021/22",Academic.Year)) %>% filter(Nationality == "UK") %>%select(Number)  %>% sum()

Scottish_total <- table_26 %>%  filter(Country.of.HE.provider == "Scotland") %>% filter(grepl("2021/22",Academic.Year)) %>% select(Number)  %>% sum()
Scottish_from_UK <- table_26 %>%  filter(Country.of.HE.provider == "Scotland") %>% filter(grepl("2021/22",Academic.Year)) %>% filter(Nationality == "UK") %>%select(Number)  %>% sum()

ggplotly(ggplot(table_26_Scottish_cs, aes(x=Academic.Year,y=Number)) + geom_col(aes(fill=Nationality)) + labs(x = "Academic year",fill="Nationality") + my_theme + scale_fill_manual(values=cbPalette))



```

*** 

#### Higher Education Staff in Computing Disciplines by Nationality, 2014/15 to 2021/22

```{r}
headline <- paste0(sprintf("%2.0f%%",(Scottish_cs_from_UK/Scottish_cs_total)*100), " of Scottish computer science academics are from the UK.\n  This compares to ", sprintf("%2.0f%%",(Scottish_from_UK/Scottish_total)*100), " for Scottish academics of all disciplines and ", sprintf("%2.0f%%",(UK_cs_from_UK/UK_cs_total)*100), " for UK computing academics.\n")

knit_print.html(paste0("<p>",headline,"</p>"))
```

**Data source:** Higher Education Statistics Authority

- [Table 26 - HE academic staff by cost centre and nationality 2014/15 to 2021/22](https://www.hesa.ac.uk/data-and-analysis/staff/table-26)

In the data, academic staff are categorised by cost centres that represent a cluster of academic disciplines.  This analysis uses the cost centre "121 IT, systems sciences & computer software engineering".    It is not possible to get finer disciplines for staff from the open data.

The HESA records cover those with contracts of employment or where the higher education provider is required to pay Class 1 National Insurance contributions. Atypical staff have working arrangements that are not permanent or where there is a complex employment relationship.   It is possible for institutions to do teaching using personnel who are not included, for instance, if they are out-sourced or self-employed.  


### Total Scottish HEI Research Income in Computing Disciplines, 2015/16 - 2020/21

```{r research_income}

read_table_5_csv <- 
  function (f) {df <- read.csv(f,skip=12) %>% 
                        filter(HESA.cost.centre.marker == "Academic departments") %>%
                        filter(grepl("121", HESA.cost.centre)) %>%
                        filter(Country.of.HE.provider == "Scotland") %>%
                        filter(HE.Provider == "Total")
                }

# problem with the 2021/22 data - no Total, just "Year to date total" - so just have to leave it out.

myfiles = lapply(list.files(path=HESA_table_5_filepath, pattern="*.csv", full.names=TRUE), read_table_5_csv)

df <- do.call("rbind", myfiles) 

totals <- df %>%
  filter(Source.of.income == "15 Total") %>%
  filter(Year.End.Month == "All") %>%
  select(starts_with("Value"),Academic.year)

colnames(totals) <- c("Value","Academic.year") # :TODO: saner way of getting clean name

totals <- totals %>%
  mutate(Value = as.numeric(Value))


ggplotly(ggplot(totals, aes(x=Academic.year,y=Value)) + geom_col() + labs(x = "Academic year",y= "Income (in thousands of pounds)") + my_theme + scale_fill_manual(values=cbPalette)) 

```

***

#### Total Scottish HEI Research Income in Computing Disciplines, 2015/16 - 2020/21

**Data source:** Higher Education Statistics Authority

- [Table 5: Research grants and contracts - breakdown by source of income and HESA cost centre 2015/16 to 2021/22](https://www.hesa.ac.uk/data-and-analysis/finances/table-5)

The cost centre we use for computing disciplines is "121 IT, systems sciences and computer software engineering".